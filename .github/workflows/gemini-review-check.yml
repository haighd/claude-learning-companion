name: Ensure AI Reviews

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  ensure-reviews:
    name: Check AI Reviewer Status
    runs-on: ubuntu-latest
    env:
      GEMINI_MARKER: '/gemini review'
    steps:
      - name: Check for AI reviewer activity
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const geminiMarker = process.env.GEMINI_MARKER;

            // Fetch all comments
            const issueComments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: prNumber }
            );

            const reviewComments = await github.paginate(
              github.rest.pulls.listReviewComments,
              { owner, repo, pull_number: prNumber }
            );

            const reviews = await github.paginate(
              github.rest.pulls.listReviews,
              { owner, repo, pull_number: prNumber }
            );

            const allComments = [...issueComments, ...reviewComments];

            // Check Gemini status
            const geminiTriggered = allComments.some((comment) => {
              return comment.body && comment.body.toLowerCase().includes(geminiMarker);
            });

            const geminiReviewed = allComments.some((comment) => {
              return comment.user && comment.user.login.includes('gemini');
            }) || reviews.some((review) => {
              return review.user && review.user.login.includes('gemini');
            });

            // Check Copilot status (auto-triggered via ruleset)
            const copilotReviewed = allComments.some((comment) => {
              return comment.user && comment.user.login.includes('copilot');
            }) || reviews.some((review) => {
              return review.user && review.user.login.includes('copilot');
            });

            // Log status
            core.info(`Gemini triggered: ${geminiTriggered}`);
            core.info(`Gemini reviewed: ${geminiReviewed}`);
            core.info(`Copilot reviewed: ${copilotReviewed}`);

            // If both reviewers have already reviewed, we're done
            if (geminiReviewed && copilotReviewed) {
              core.info('Both AI reviewers have reviewed. Check passed.');
              return;
            }

            // If Gemini already reviewed (even without explicit trigger), skip posting
            if (geminiReviewed) {
              core.info('Gemini already reviewed; waiting for Copilot.');
              return;
            }

            // Post Gemini trigger only if Gemini hasn't reviewed yet
            if (!geminiTriggered && !geminiReviewed) {
              const reminder = [
                'ü§ñ **AI Review Status**',
                '',
                '| Reviewer | Status |',
                '|----------|--------|',
                `| Gemini | Triggering... |`,
                `| Copilot | ${copilotReviewed ? '‚úÖ Active' : '‚è≥ Pending (auto-triggered)'} |`,
                '',
                'This comment includes the required `/gemini review` marker.',
                '',
                geminiMarker
              ].join('\n');

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: reminder
              });

              core.info('Posted AI review status with Gemini trigger.');
            } else {
              core.info('Gemini already triggered; skipping reminder.');
            }
