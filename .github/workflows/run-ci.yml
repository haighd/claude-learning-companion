name: Run CI

on:
  issue_comment:
    types: [created]

jobs:
  check-trigger:
    name: Check /run-ci trigger
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/run-ci')
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ github.event.issue.number }}
    steps:
      - name: Check commenter permissions
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.comment.user.login
            });

            const hasWriteAccess = ['admin', 'write'].includes(permission.permission);

            if (!hasWriteAccess) {
              console.log(`User ${context.payload.comment.user.login} does not have write access`);
              core.setOutput('should_run', 'false');
              return;
            }

            console.log(`User ${context.payload.comment.user.login} has ${permission.permission} access - triggering CI`);
            core.setOutput('should_run', 'true');

      - name: Add reaction to comment
        if: steps.check.outputs.should_run == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

  check-thread-status:
    name: Check Review Threads
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    outputs:
      blocking_count: ${{ steps.categorize.outputs.blocking_count }}
      total_unresolved: ${{ steps.categorize.outputs.total_unresolved }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.check-trigger.outputs.pr_number }}/head

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Categorize review findings
        id: categorize
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x scripts/categorize-findings.py
          if ! FINDINGS=$(python3 scripts/categorize-findings.py "${{ needs.check-trigger.outputs.pr_number }}"); then
            echo "::error::Failed to categorize review findings"
            exit 1
          fi

          echo "Findings breakdown:"
          echo "$FINDINGS" | jq '.summary'

          BLOCKING=$(echo "$FINDINGS" | jq '.counts.blocking_count')
          TOTAL=$(echo "$FINDINGS" | jq '.counts.total_unresolved')

          echo "blocking_count=$BLOCKING" >> $GITHUB_OUTPUT
          echo "total_unresolved=$TOTAL" >> $GITHUB_OUTPUT

          if [ "$BLOCKING" -gt 0 ]; then
            CRITICAL=$(echo "$FINDINGS" | jq '.summary.critical')
            HIGH=$(echo "$FINDINGS" | jq '.summary.high')
            echo "::error::Found $BLOCKING critical/high severity finding(s) that must be addressed"
            echo "::error::Critical: $CRITICAL, High: $HIGH"
            exit 1
          fi

          if [ "$TOTAL" -gt 0 ]; then
            MEDIUM=$(echo "$FINDINGS" | jq '.summary.medium')
            LOW=$(echo "$FINDINGS" | jq '.summary.low')
            echo "::notice::$TOTAL unresolved thread(s) remaining (medium: $MEDIUM, low: $LOW) - CI proceeding"
          else
            echo "All review threads resolved. CI can proceed."
          fi

  python-checks:
    name: Python Syntax & Lint
    needs: [check-trigger, check-thread-status]
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: false

      - name: Check available disk space
        run: |
          echo "Available disk space:"
          df -h /
          # Use --block-size=1G for consistent GB output regardless of size
          AVAIL=$(df --block-size=1G / | awk 'NR==2 {print $4}')
          if [ "$AVAIL" -lt 10 ]; then
            echo "::error::Less than 10GB available ($AVAIL GB). Failing early."
            exit 1
          fi
          echo "✓ Sufficient disk space available ($AVAIL GB)"

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.check-trigger.outputs.pr_number }}/head

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      - name: Check Python syntax
        run: |
          echo "Checking Python syntax..."
          find . -name "*.py" -not -path "./dashboard-app/frontend/*" -not -path "./.git/*" | head -50 | while read file; do
            python -m py_compile "$file" && echo "✓ $file" || echo "✗ $file"
          done
          echo "Syntax check complete"

  run-tests:
    name: Run Tests
    needs: [check-trigger, check-thread-status, python-checks]
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail if no tests exist
    outputs:
      tests_result: ${{ steps.test.outputs.result }}
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.check-trigger.outputs.pr_number }}/head

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-asyncio || true

      - name: Run tests
        id: test
        run: |
          if [ -d "tests" ] && [ "$(find tests -name 'test_*.py' | wc -l)" -gt 0 ]; then
            echo "Running pytest..."
            python -m pytest tests/ -v --tb=short 2>&1 || true
            echo "result=ran" >> $GITHUB_OUTPUT
          else
            echo "No tests configured - skipping"
            echo "result=skipped" >> $GITHUB_OUTPUT
          fi

  finalize:
    name: Finalize CI
    needs: [check-trigger, check-thread-status, python-checks, run-tests]
    if: always() && needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs status
        id: status
        run: |
          # Thread check and Python checks must pass
          # Tests can be skipped or fail (continue-on-error) for now
          if [ "${{ needs.check-thread-status.result }}" == "success" ] && [ "${{ needs.python-checks.result }}" == "success" ]; then
            echo "all_passed=true" >> $GITHUB_OUTPUT
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Report CI success
        if: steps.status.outputs.all_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = '${{ needs.run-tests.outputs.tests_result }}' || 'unknown';
            const testStatus = testResult === 'skipped'
              ? '(tests skipped - none configured)'
              : '(tests ran)';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.pr_number }},
              body: `✅ CI checks passed ${testStatus}. Auto-approval workflow will run next.`
            });

            // Note: ready-to-merge label is now added by auto-approve.yml after bot approval

      - name: Report failure
        if: steps.status.outputs.all_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              thread_check: '${{ needs.check-thread-status.result }}',
              python_checks: '${{ needs.python-checks.result }}',
              tests: '${{ needs.run-tests.result }}'
            };

            const failed = Object.entries(results)
              .filter(([_, status]) => status !== 'success' && status !== 'skipped')
              .map(([name, status]) => `- ${name}: ${status}`)
              .join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.pr_number }},
              body: `❌ CI checks failed:\n\n${failed}\n\nPlease fix the issues and run \`/run-ci\` again after getting review approval.`
            });
